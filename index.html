<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <title>reveal.js</title>
  <link rel="stylesheet" href="dist/reset.css" />
  <link rel="stylesheet" href="dist/reveal.css" />
  <link rel="stylesheet" href="dist/theme/black.css" />
  <!-- Theme used for syntax highlighted code -->
  <link rel="stylesheet" href="plugin/highlight/monokai.css" />
</head>

<body>
  <div class="reveal">
    <div class="slides">
      <section>
        <h2 class="r-fit-text">STARTSEITE</h2>
      </section>
      <section>
        <h2 class="r-fit-text">Inhaltsverzeichnis</h2>
      </section>
      <section>
        <section>
          <h2 class="r-fit-text">Wo alles beginnt</h2>
        </section>
        <section>
          <h5>Slotted pages</h5>
        </section>
        <section>
          <h5>Defragmentierung</h5>
        </section>
        <section>
          <h5>Page types</h5>
        </section>
        <section>
          <h5>Allocation Information Page</h5>
        </section>
      </section>
      <section>
        <section>
          <h2 class="r-fit-text">Global Allocation Map</h2>
        </section>
        <section>
          <h5>Allokationen merken</h5>
        </section>
        <section>
          <h5>Die letzte allokierte Seite finden</h5>
          <p class="fragment">erste Optimierungen</p>
          <ul>
            <li class="fragment">Edge cases direkt behandeln (leer und voll)</li>
            <li class="fragment">als longs Daten betrachten</li>
            <li class="fragment">Intrinsics nutzen</li>
          </ul>
        </section>
        <section>
          <h5>erste Version</h5>
          <pre><code data-trim data-noescape>
public int DefaultLoop(Span<byte> span)
{
    Span<ulong> longSpan = MemoryMarshal.Cast<byte, ulong>(span);

    if (longSpan[0] == 0)
        return 1;

    if (longSpan[^1] == long.MaxValue)
        return -1;

    int iterCount = longSpan.Length / 4;
    for (int i = 0; i < iterCount; i++)
    {
        ref ulong l = ref longSpan[i];
        if (l == ulong.MaxValue)
            continue;
        int res = 0;
        var count = BitOperations.LeadingZeroCount(l);
        res = (64 - count) + 1;
        if (i > 0 && res != -1)
            res += (64 * i);
        return res;
    }

    return -1;
}
  </code></pre>
          <div class="fragment">
            <div style="overflow-x:auto">
              <table>
                <thead>
                  <tr>
                    <th>Method</th>
                    <th>Iterations</th>
                    <th style="text-align:right">Mean</th>
                    <th style="text-align:right">Error</th>
                    <th style="text-align:right">StdDev</th>
                    <th style="text-align:right">Median</th>
                    <th style="text-align:right">Ratio</th>
                    <th style="text-align:right">RatioSD</th>
                    <th>Baseline</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Loop</td>
                    <td>1000</td>
                    <td style="text-align:right">138.85 μs</td>
                    <td style="text-align:right">1.539 μs</td>
                    <td style="text-align:right">2.303 μs</td>
                    <td style="text-align:right">138.74 μs</td>
                    <td style="text-align:right">1.00</td>
                    <td style="text-align:right">0.00</td>
                    <td>Yes</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
        <section>
          <h5>Loop unrolling</h5>
          <pre><code data-trim data-noescape>
public int Unroll4(Span<byte> span)
{
    Span<ulong> longSpan = MemoryMarshal.Cast<byte, ulong>(span);

    if (longSpan[0] == 0)
        return 1;

    if (longSpan[^1] == long.MaxValue)
        return -1;

    int iterCount = longSpan.Length;
    for (int i = 0; i < iterCount; i += 4)
    {
        ref ulong l4 = ref longSpan[i + 3];
        // when l4 is max value all others before too
        if (l4 == ulong.MaxValue)
            continue;

        ref ulong l1 = ref longSpan[i];
        ref ulong l2 = ref longSpan[i + 1];
        ref ulong l3 = ref longSpan[i + 2];

        int res = -1;
        if (l1 != ulong.MaxValue)
        {
            var count = BitOperations.LeadingZeroCount(l1);

            res = (64 - count) + 1;
        }
        else if (l2 != ulong.MaxValue)
        {
            var count = BitOperations.LeadingZeroCount(l2);
            res = (64) - count + 64 + 1;
        }
        else if (l3 != ulong.MaxValue)
        {
            var count = BitOperations.LeadingZeroCount(l3);
            res = (64) - count + 128 + 1;
        }
        else if (l4 != ulong.MaxValue)
        {
            var count = BitOperations.LeadingZeroCount(l4);
            res = (64) - count + 192 + 1;
        }

        if (i > 0 && res != -1)
            res += (64 * i);

        return res;
    }

    return -1;
}
  </code></pre>

          <div class="fragment">
            <table>
              <thead>
                <tr>
                  <th>Method</th>
                  <th>Iterations</th>
                  <th style="text-align:right">Mean</th>
                  <th style="text-align:right">Error</th>
                  <th style="text-align:right">StdDev</th>
                  <th style="text-align:right">Median</th>
                  <th style="text-align:right">Ratio</th>
                  <th style="text-align:right">RatioSD</th>
                  <th>Baseline</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Loop</td>
                  <td>1000</td>
                  <td style="text-align:right">138.85 μs</td>
                  <td style="text-align:right">1.539 μs</td>
                  <td style="text-align:right">2.303 μs</td>
                  <td style="text-align:right">138.74 μs</td>
                  <td style="text-align:right">1.00</td>
                  <td style="text-align:right">0.00</td>
                  <td>Yes</td>
                </tr>
                <tr>
                  <td>LoopUnrolled4</td>
                  <td>1000</td>
                  <td style="text-align:right">102.69 μs</td>
                  <td style="text-align:right">1.514 μs</td>
                  <td style="text-align:right">2.171 μs</td>
                  <td style="text-align:right">102.61 μs</td>
                  <td style="text-align:right">0.74</td>
                  <td style="text-align:right">0.02</td>
                  <td>No</td>
                </tr>
                <tr>
                  <td>LoopUnrolled2</td>
                  <td>1000</td>
                  <td style="text-align:right">155.59 μs</td>
                  <td style="text-align:right">2.035 μs</td>
                  <td style="text-align:right">2.918 μs</td>
                  <td style="text-align:right">156.24 μs</td>
                  <td style="text-align:right">1.12</td>
                  <td style="text-align:right">0.03</td>
                  <td>No</td>
                </tr>
                <tr>
                  <td>LoopUnrolled8</td>
                  <td>1000</td>
                  <td style="text-align:right">77.82 μs</td>
                  <td style="text-align:right">1.153 μs</td>
                  <td style="text-align:right">1.690 μs</td>
                  <td style="text-align:right">77.90 μs</td>
                  <td style="text-align:right">0.56</td>
                  <td style="text-align:right">0.02</td>
                  <td>No</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
        <section>
          <h5>Binary search</h5>
          <div>
            <span>$\mathcal{O}(n)$</span>
            <span>vs.</span>
            <span>$\mathcal{O}(\log{}n)$</span>
          </div>
          <div class="fragment" data-fragment-index="0">
            $\log_2 8124 \approx 13$
          </div>
          <div class="r-stack">
            <img class="fragment current-visible" data-fragment-index="1"
              src="https://codemonkeyspace.b-cdn.net/post/2021/gam/bigo.svg" width="400" height="400">
            <img class="fragment" data-fragment-index="2"
              src="https://codemonkeyspace.b-cdn.net/post/2021/gam/binarysearch.svg" width="400" height="400">
          </div>
        </section>
        <section>
          <pre><code data-trim data-noescape data-line-numbers="17-18|20|28-33|42-51">
public int FindBinarySearch(Span<byte> spanByte)
{
    Span<ulong> span = MemoryMarshal.Cast<byte, ulong>(spanByte);

    if (span[0] == 0)
        return 1;

    if (span[^1] == long.MaxValue)
        return -1;

    int min = 0;
    int max = span.Length - 1;
    int index = -1;

    while (min <= max)
    {
        int mid = (int)unchecked((uint)(min + max) >> 1);
        ref var b = ref span[mid];

        if (b != ulong.MaxValue)
        {
            if (mid == 0)
            {
                index = 0;
                break;
            }

            ref var b1 = ref span[mid - 1];
            if (b1 == ulong.MaxValue)
            {
                index = mid;
                break;
            }

            max = mid - 1;
            continue;
        }

        min = mid + 1;
    }

    if (index > -1)
    {
        int res = 0;
        ref var l = ref span[index];
        var count = BitOperations.LeadingZeroCount((ulong)l);
        res = (64 - count) + 1;
        if (index > 0 && res != -1)
            res += (64 * index);
        return res;
    }

    return index;
}
  </code></pre>
          <table class="fragment">
            <thead>
              <tr>
                <th>Method</th>
                <th>Iterations</th>
                <th style="text-align:right">Mean</th>
                <th style="text-align:right">Error</th>
                <th style="text-align:right">StdDev</th>
                <th style="text-align:right">Median</th>
                <th style="text-align:right">Ratio</th>
                <th style="text-align:right">RatioSD</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Loop</td>
                <td>1000</td>
                <td style="text-align:right">138.85 μs</td>
                <td style="text-align:right">1.539 μs</td>
                <td style="text-align:right">2.303 μs</td>
                <td style="text-align:right">138.74 μs</td>
                <td style="text-align:right">1.00</td>
                <td style="text-align:right">0.00</td>
              </tr>
              <tr>
                <td>LoopUnrolled8</td>
                <td>1000</td>
                <td style="text-align:right">77.82 μs</td>
                <td style="text-align:right">1.153 μs</td>
                <td style="text-align:right">1.690 μs</td>
                <td style="text-align:right">77.90 μs</td>
                <td style="text-align:right">0.56</td>
                <td style="text-align:right">0.02</td>
              </tr>
              <tr>
                <td>BinarySearchLike</td>
                <td>1000</td>
                <td style="text-align:right">56.73 μs</td>
                <td style="text-align:right">1.024 μs</td>
                <td style="text-align:right">1.501 μs</td>
                <td style="text-align:right">56.48 μs</td>
                <td style="text-align:right">0.41</td>
                <td style="text-align:right">0.01</td>
              </tr>
            </tbody>
          </table>
        </section>
        <section>
          <h5>Lookup</h5>
           <pre class="fragment"><code data-trim data-noescape>
int res = 0;
ref var l = ref span[index];
var count = BitOperations.LeadingZeroCount((ulong)l);
res = (64 - count) + 1;
if (index > 0 && res != -1)
    res += (64 * index);
return res;
  </code></pre>
   <pre class="fragment"><code data-trim data-noescape>
int res = 0;
ref var l = ref span[index];
res = _lookup[l];
if (index > 0 && res != -1)
    res += (64 * index);
return res;
  </code></pre>
        </section>
        <section>
          <h5>Allocation Information Page</h5>
        </section>
        <section>
          <h5>Allocation Information Page</h5>
        </section>
      </section>
    </div>
  </div>

  <script src="dist/reveal.js"></script>
  <script src="plugin/notes/notes.js"></script>
  <script src="plugin/markdown/markdown.js"></script>
  <script src="plugin/highlight/highlight.js"></script>
  <script src="plugin/math/math.js"></script>
  <script>
    //   $\mathcal{O}(n\log{}n)$
    // More info about initialization & config:
    // - https://revealjs.com/initialization/
    // - https://revealjs.com/config/
    Reveal.initialize({
      hash: true,
      slideNumber: true,
      // Learn about plugins: https://revealjs.com/plugins/
      plugins: [RevealMarkdown, RevealHighlight, RevealNotes, RevealMath],
    });
  </script>
</body>

</html>